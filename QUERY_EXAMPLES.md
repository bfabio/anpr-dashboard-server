# Query examples

The document provides some examples around queries used to retrieve useful data from the database.

Search the supplier name (*fornitore*), given a municipality name (*comune*).

```sql
SELECT C.NAME, F.NAME as NOME_FORNITORE FROM COMUNE C
INNER JOIN FORNITORE F ON F.ID=C.ID_FORNITORE
WHERE UPPER(C.NAME) LIKE  "%CARATE BRIANZA%";

SELECT ID, NAME FROM FORNITORE WHERE UPPER(FORNITORE.NAME) LIKE "%SYSTEM%";
```

Change the supplier name (*fornitore*) for a given municipality (*comune*).

```sql
UPDATE COMUNE SET ID_FORNITORE = (SELECT ID FROM FORNITORE WHERE  UPPER(FORNITORE.NAME)="AP SYSTEMS") WHERE COMUNE.NAME="CARATE BRIANZA";
```

Add a "referente" for a given "fornitore".
```sql
INSERT INTO REFERENTI (ID, NAME, EMAIL_REFERENTE) VALUES((SELECT ID FROM FORNITORE WHERE NAME="Accenture S.p.A."), "Accenture S.p.A.", "email@example.tld");
```
Please note above operation must be done in config file too.

Extract the municipality takeover plan

```sql
SELECT COMUNE.NAME,
FORNITORE.NAME as FORNITORE,
COMUNE.POPOLAZIONE,  
date(SUBENTRO.RANGE_FROM, 'unixepoch') as DATE_FROM,
date(SUBENTRO.RANGE_TO, 'unixepoch') as DATE_TO
FROM COMUNE
INNER JOIN FORNITORE on FORNITORE.ID=COMUNE.ID_FORNITORE
INNER JOIN SUBENTRO on SUBENTRO.ID_COMUNE=COMUNE.ID ORDER BY SUBENTRO.RANGE_FROM ASC;
```

To extract the municipality takeover query

```shell
sqlite3 -header -csv db.sqlite < query.sql > subentro.csv
```

Get the list of suppliers that still haven't helped any municipality

```sql
SELECT FORNITORE.NAME as FORNITORE,
COUNT(FORNITORE.NAME) as NUMERO
FROM COMUNE
INNER JOIN FORNITORE on FORNITORE.ID=COMUNE.ID_FORNITORE
INNER JOIN SUBENTRO on SUBENTRO.ID_COMUNE=COMUNE.ID
WHERE COMUNE.DATA_SUBENTRO IS NULL
GROUP BY FORNITORE.NAME;
```

Sum of the municipalities that have not yet taken over

```sql
SELECT SUM(COMUNE.POPOLAZIONE)
FROM COMUNE
INNER JOIN FORNITORE on FORNITORE.ID=COMUNE.ID_FORNITORE
INNER JOIN SUBENTRO on SUBENTRO.ID_COMUNE=COMUNE.ID AND SUBENTRO.RANGE_TO <CAST(strftime('%s', '2017-12-31') AS INT) AND COMUNE.SUBENTRO_DATE IS NULL  
```

Some examples of municipalities insertions:

```sql
INSERT INTO COMUNE (NAME, ID_FORNITORE, PROVINCIA, CODICE_ISTAT, POSTAZIONI, POPOLAZIONE, REGION, LAT, LON)
VALUES("BELVEDERE MARITTIMO", 4, "CS", "078015", 4, 9240, "CALABRIA", 39.6332469, 15.8417781);

INSERT INTO COMUNE (NAME, ID_FORNITORE, PROVINCIA, CODICE_ISTAT, POSTAZIONI, POPOLAZIONE, REGION, LAT, LON)
VALUES("MONTECCHIO EMILIA", 3, "RE", "035027", 0, 10622, "EMILIA ROMAGNA", 44.7084791, 10.4255221);

INSERT INTO COMUNE (NAME, ID_FORNITORE, PROVINCIA, CODICE_ISTAT, POSTAZIONI, POPOLAZIONE, REGION, LAT, LON)
VALUES("GARDA", 23, "VR", "023036", 3, 4126, "VENETO", 45.5787644, 10.6852263);

INSERT INTO COMUNE (NAME, ID_FORNITORE, PROVINCIA, CODICE_ISTAT, POSTAZIONI, POPOLAZIONE, REGION, LAT, LON)
VALUES("TRIBIANO", 22, "MI", "015222", 2, 3535, "LOMBARDIA", 45.4126596, 9.3673043);
```

Update the takeover dates for a specific municipality

Verify first if Comune exists and ID is correctly returned
```sql
SELECT ID FROM COMUNE WHERE NAME="CASTELLEONE";
```
Then, verify if exists in SUBENTRO table
```sql
select * from SUBENTRO WHERE ID_COMUNE=(SELECT ID FROM COMUNE WHERE NAME="CASTELLEONE");
```

if so, run:
```sql
UPDATE SUBENTRO SET RANGE_FROM=strftime('%s','2020-12-22'), RANGE_TO=strftime('%s','2020-12-22'), FINAL_DATE=strftime('%s','2020-12-22') WHERE ID_COMUNE=(SELECT ID FROM COMUNE WHERE NAME="CASTELLEONE");
```
if not, run:
```sql
INSERT into SUBENTRO (ID_COMUNE, RANGE_FROM, RANGE_TO, FINAL_DATE) VALUES((SELECT ID FROM COMUNE WHERE NAME="CASTELLEONE"), strftime('%s','2020-12-22'),strftime('%s','2020-12-22'),strftime('%s','2020-12-22'));
```
